# Mitmproxy Dynamic Domain Blocker

## 概要 (Overview)

これは `mitmproxy` のアドオン（Addon）スクリプトです。
Webブラウザの管理画面から、指定したドメインリストのブロック/許可をリアルタイムに切り替えることができます。

`mitmweb` と連携させることで、スマートフォンの通信内容をリアルタイムに閲覧しながら、特定のWebサイトやアプリの通信だけを動的にブロック/許可するといった高度な制御が可能です。

  
*(ここにコントロールパネルのスクリーンショット画像を挿入すると、より分かりやすくなります)*

### 主な機能

*   **動的なフィルタリング:** Web UI上のスイッチを切り替えるだけで、特定のドメインへのアクセスを即座にブロック/許可できます。
*   **リアルタイム通信監視:** `mitmweb` と統合されているため、ブロック処理と同時にすべての通信フローを閲覧・解析できます。
*   **シンプルな起動:** 必要なサーバー機能（プロキシ、Web UI）は、単一のコマンドで全て起動します。
*   **簡単な導入:** Pythonと数個のライブラリをインストールするだけで、すぐに利用を開始できます。

## 必要なもの (Prerequisites)

このツールを実行するには、お使いのPCに以下のソフトウェアがインストールされている必要があります。

1.  **Python 3.8以上**
2.  **mitmproxy:** プロキシ本体です。
3.  **Flask:** Web管理画面のために使用します。

## セットアップ (Setup)

### 1. リポジトリのクローンまたはダウンロード

まず、このプロジェクトのファイル一式をPCに配置します。

```bash
git clone https://github.com/J105588/Mitmproxy-Dynamic-Domain-Blocker.git
cd Mitmproxy-Dynamic-Domain-Blocker
```
または、ファイルをダウンロードします。

### 2. 必要なPythonライブラリのインストール

`mitmproxy` と `Flask` をインストールします。ターミナル（コマンドプロンプト）で以下のコマンドを実行してください。

```bash
pip install mitmproxy flask
```

### 3. スクリプトとHTMLファイルの確認

プロジェクトフォルダ内に、以下のファイルが存在することを確認してください。

*   `mitm_controller.py`: メインのスクリプトファイルです。
*   `control_page_per_domain.html`: Web管理画面のUIを定義するHTMLファイルです。
*   `block_page.html`: ドメインをブロックした際に表示されるページのHTMLファイルです。

### 4. (任意) ブロック対象ドメインの編集

`mitm_controller.py` をテキストエディタで開き、`TARGET_DOMAINS` のリストを編集することで、管理画面に表示するドメインを自由に変更できます。

```python
# --- 設定項目 ---
TARGET_DOMAINS = [
    "youtube.com", 
    "tiktok.com", 
    "x.com", 
    # ... ここを自由に編集 ...
]
# ----------------
```

## 使い方 (Usage)

### 1. スクリプトの起動

ターミナルでプロジェクトフォルダに移動し、以下のコマンドを実行します。

```bash
mitmweb -s mitm_controller.py
```

起動に成功すると、ターミナルに以下のような情報が表示され、PCのWebブラウザが自動的に開いて管理画面が表示されます。

```
Web server listening at http://127.0.0.1:8081/
Proxy server listening at http://*:8080
----------------------------------------------------
[*] 管理画面 URL: http://192.168.0.10:8082
[*] PCのブラウザからは http://127.0.0.1:8082 でアクセス
----------------------------------------------------
```

### 2. スマートフォンのプロキシ設定

通信を監視・制御したいスマートフォンで、以下の設定を行います。

1.  PCと同じWi-Fiネットワークに接続します。
2.  Wi-Fiの詳細設定を開き、HTTPプロキシを手動設定モードにします。
3.  以下の情報を設定します。
    *   **サーバー (IPアドレス):** ターミナルに表示されたPCのIPアドレス（例: `192.168.0.10`）
    *   **ポート:** `8080`

### 3. 証明書のインストール

HTTPS通信を復号化（中身を見る）するために、スマートフォンに `mitmproxy` の証明書をインストールする必要があります。

1.  プロキシ設定が完了したスマートフォンで、Webブラウザを開きます。
2.  アドレスバーに `mitm.it` と入力してアクセスします。
3.  お使いのOS（iOS/Androidなど）のアイコンをタップし、指示に従って証明書をダウンロードし、インストール・信頼設定を行ってください。

### 4. フィルタリングの制御

*   PCのブラウザで開いている**管理画面 (http://127.0.0.1:8082)** で、ドメインごとのスイッチをON/OFFすることで、リアルタイムにブロック設定を変更できます。
*   `mitmweb` の**ビューア画面 (http://127.0.0.1:8081)** で、スマートフォンの通信がリアルタイムに表示されるのを確認できます。ブロックされた通信は、スクリプトによって `200 OK` のステータスコードで `block_page.html` の内容が返されるため、Webビューア上でも識別可能です。

## トラブルシューティング (Troubleshooting)

*   **スマートフォンでインターネットに接続できない:**
    *   PCでスクリプトが正しく起動しているか確認してください。
    *   スマートフォンのプロキシ設定（IPアドレスとポート番号）が正しいか再確認してください。
    *   PCのファイアウォールが `mitmweb` の通信（特にポート `8080`）をブロックしていないか確認してください。

*   **管理画面が表示されない:**
    *   スクリプト起動時にエラーが出ていないか確認してください。
    *   `Flask` が正しくインストールされているか確認してください。
    *   `control_page_per_domain.html` がスクリプトと同じフォルダにあるか確認してください。

*   **HTTPSサイトがエラーになる:**
    *   `mitm.it` からの証明書が正しくインストールされ、「信頼されている」状態になっているか確認してください。特にiOSでは「設定 > 一般 > 情報 > 証明書信頼設定」で手動で信頼を有効にする必要があります。
